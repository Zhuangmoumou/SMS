name: Build Ren'Py Game

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  RENPY_VERSION: '8.3.2'
  PROJECT_NAME: 'SMS' # 你的项目英文名

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1. 目录重组 (保持不变，针对你的根目录结构)
      - name: Restructure directory
        run: |
          mkdir -p build_work/${{ env.PROJECT_NAME }}/game
          # 移动所有文件到 game 目录
          rsync -av --exclude='.git' --exclude='.github' --exclude='build_work' ./ build_work/${{ env.PROJECT_NAME }}/game/

          # 将 android.json 移回项目根目录 (game 的上一级)
          if [ -f "build_work/${{ env.PROJECT_NAME }}/game/android.json" ]; then
            mv "build_work/${{ env.PROJECT_NAME }}/game/android.json" "build_work/${{ env.PROJECT_NAME }}/"
            echo "Moved android.json to project root."
          fi

      # 2. 解码 Keystore 文件
      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          # 将 Base64 转换回 android.keystore 文件，放在项目根目录下
          echo "$ANDROID_KEYSTORE_B64" | base64 --decode > build_work/${{ env.PROJECT_NAME }}/android.keystore
          echo "Keystore decoded successfully."

      # 3. 安装 Ren'Py 环境 (包含 Android SDK)
      # 这里我们配置了 android_properties 来注入签名信息
      - name: Install Ren'Py with Android Support
        uses: Ayowel/renpy-setup-action@v2.0.1
        with:
          action: install
          version: ${{ env.RENPY_VERSION }}
          install_dir: ${{ runner.temp }}/renpy
          dlcs: android
          android_sdk: true
          # 关键：配置签名信息，让 Ren'Py 知道使用你的 key
          android_properties: |
            key.alias=${{ secrets.ANDROID_KEY_ALIAS }}
            key.store.password=${{ secrets.ANDROID_KEY_STORE_PASSWORD }}
            key.alias.password=${{ secrets.ANDROID_KEY_PASSWORD }}
            key.store=${{ github.workspace }}/build_work/${{ env.PROJECT_NAME }}/android.keystore

      # 4. 构建 Android APK
      - name: Build Android APK
        uses: Ayowel/renpy-setup-action@v2.0.1
        with:
          action: android_build
          install_dir: ${{ runner.temp }}/renpy
          game: 'build_work/${{ env.PROJECT_NAME }}' # 指向项目根目录
          build_type: 'apk' # 只构建 apk
          out_dir: 'dist_android'

      # 5. 构建 PC 版 (Win/Linux/Mac)
      - name: Build PC Distributions
        uses: Ayowel/renpy-setup-action@v2.0.1
        with:
          action: distribute
          install_dir: ${{ runner.temp }}/renpy
          game: 'build_work/${{ env.PROJECT_NAME }}'
          packages: 'pc' # 或者 'win linux mac'
          out_dir: 'dist_pc'

      # 6. 构建 Web 版
      - name: Build Web Version
        uses: Ayowel/renpy-setup-action@v2.0.1
        with:
          action: distribute
          install_dir: ${{ runner.temp }}/renpy
          game: 'build_work/${{ env.PROJECT_NAME }}'
          packages: 'web'
          out_dir: 'dist_web'

      # ---------------------------------------------------------
      # 上传产物
      # ---------------------------------------------------------
      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-APK
          path: dist_android/*.apk

      - name: Upload PC Build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-PC
          path: dist_pc/*.zip
          if-no-files-found: warn

      - name: Upload Web Build
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-Web
          path: dist_web/*.zip
